# Configuración de despliegue para entornos de producción. Esta variante
# utiliza las imágenes previamente construidas y aplica políticas de
# reinicio para mayor resiliencia. Ajusta las variables de entorno
# GIT_REPO_URL y GIT_BRANCH según tu repositorio.

services:
  ingestor:
    image: cognitive/ingestor:latest
    user: "${COGNITIVE_UID:-10001}:${COGNITIVE_GID:-10001}"
    read_only: true
    tmpfs:
      - /tmp
    cap_drop:
      - ALL
    security_opt:
      - no-new-privileges:true
    init: true
    volumes:
      - ./data/input:/data/input:ro
      - ./outputs:/data/outputs
    restart: always

  pipeline:
    image: cognitive/pipeline:latest
    user: "${COGNITIVE_UID:-10001}:${COGNITIVE_GID:-10001}"
    read_only: true
    tmpfs:
      - /tmp
    cap_drop:
      - ALL
    security_opt:
      - no-new-privileges:true
    init: true
    environment:
      - COGNITIVE_ENV=prod
      - COGNITIVE_HASH_SALT=${COGNITIVE_HASH_SALT:-}
      - COGNITIVE_AUDIT_LOG=/data/outputs/audit/analysis.jsonl
    volumes:
      - ./outputs:/data/outputs
      - ./schemas:/schemas
    restart: always

  frontend:
    image: cognitive/frontend:latest
    user: "${COGNITIVE_UID:-10001}:${COGNITIVE_GID:-10001}"
    read_only: true
    tmpfs:
      - /tmp
    cap_drop:
      - ALL
    security_opt:
      - no-new-privileges:true
    init: true
    ports:
      - "8501:80"
    environment:
      - COGNITIVE_ENV=prod
      - COGNITIVE_UI_AUTH_REQUIRED=1
      - COGNITIVE_UI_TOKEN_VIEWER=${COGNITIVE_UI_TOKEN_VIEWER:-}
      - COGNITIVE_UI_TOKEN_ANALYST=${COGNITIVE_UI_TOKEN_ANALYST:-}
      - COGNITIVE_UI_TOKEN_ADMIN=${COGNITIVE_UI_TOKEN_ADMIN:-}
      - COGNITIVE_UI_AUDIT_LOG=/audit/ui_access.jsonl
      - COGNITIVE_HASH_SALT=${COGNITIVE_HASH_SALT:-}
    volumes:
      - ./outputs:/outputs:ro
      - ./audit:/audit
    restart: always

  gitops:
    image: cognitive/gitops:latest
    user: "${COGNITIVE_UID:-10001}:${COGNITIVE_GID:-10001}"
    read_only: true
    tmpfs:
      - /tmp
    cap_drop:
      - ALL
    security_opt:
      - no-new-privileges:true
    init: true
    environment:
      - COGNITIVE_ENV=prod
      - GITOPS_DATA_MODE=redacted
      - GIT_REPO_URL=${GIT_REPO_URL}
      - GIT_BRANCH=${GIT_BRANCH:-main}
    volumes:
      - ./outputs:/outputs:ro
    restart: on-failure
