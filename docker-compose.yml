services:
  ingestor:
    build:
      context: .
      dockerfile: ingestor/Dockerfile
    image: cognitive/ingestor:latest
    volumes:
      - ./data/input:/data/input
      - ./outputs:/data/outputs
    # Procesar todos los archivos de /data/input y volcar resultados en /data/outputs/raw
    command: ["python", "ingest.py", "/data/input", "--output", "/data/outputs/raw"]

  pipeline:
    build:
      context: .
      dockerfile: pipeline/Dockerfile
    image: cognitive/pipeline:latest
    volumes:
      - ./outputs:/data/outputs
      - ./schemas:/schemas
      - ./outputs:/outputs
    # Analizar los textos ingeridos y generar insights en JSON
    command: [
      "python",
      "analyze.py",
      "--input",
      "/data/outputs/raw",
      "--output",
      "/data/outputs/insights/analysis.json",
      "--schema",
      "/schemas/semantic-schema.yaml"
    ]

  frontend:
    build:
      context: .
      dockerfile: frontend/Dockerfile
    image: cognitive/frontend:latest
    ports:
      - "8501:8501"
    volumes:
      - ./outputs:/outputs
    # El comando por defecto se define en el Dockerfile para ejecutar
    # Streamlit. Puede sobreescribirse para usar la interfaz de
    # consola (app.py) o la TUI rich (tui.py).
    command: []

  gitops:
    build:
      context: .
      dockerfile: gitops/Dockerfile
    image: cognitive/gitops:latest
    environment:
      - GIT_REPO_URL=git@github.com:TU_USUARIO/mi-cerebro-digital.git
      - GIT_BRANCH=main
    volumes:
      - ./outputs:/outputs
