name: "Regulatory XP Award"

on:
  pull_request:
    types: [labeled]
  workflow_dispatch:

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  award-regulatory-xp:
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Set up Python runtime
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: |
          pip install PyYAML

      - name: Collect pull request metadata
        id: pr-info
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const pr = context.payload.pull_request;
            if (!pr) {
              throw new Error('No pull request payload available');
            }
            const labels = (pr.labels || [])
              .map((label) => (typeof label === 'string' ? label : label?.name))
              .filter(Boolean);
            core.setOutput('user', pr.user?.login || '');
            core.setOutput('pr_number', (pr.number || 0).toString());
            core.setOutput('labels', JSON.stringify(labels.map((label) => label.toLowerCase())));
            core.setOutput('timestamp', new Date().toISOString());
            core.setOutput('pr_url', pr.html_url || '');

      - name: Award regulatory XP
        id: award
        run: |
          PR_USER="${{ steps.pr-info.outputs.user }}"
          PR_NUMBER="${{ steps.pr-info.outputs.pr_number }}"
          LABELS="${{ steps.pr-info.outputs.labels }}"
          TIMESTAMP="${{ steps.pr-info.outputs.timestamp }}"
          RESULT_FILE=$(mktemp)
          python scripts/award-regulatory-xp.py \
            --user "$PR_USER" \
            --pr "$PR_NUMBER" \
            --labels "$LABELS" \
            --timestamp "$TIMESTAMP" > "$RESULT_FILE"
          cat "$RESULT_FILE"
          export RESULT_FILE
          python - <<'PY' >> $GITHUB_OUTPUT
            import json, os
            path = os.environ['RESULT_FILE']
            data = json.loads(open(path).read())
            print(f"awarded={'true' if data.get('awarded') else 'false'}")
            print(f"xp_awarded={data.get('xp', 0)}")
            entries = [entry.get('type') or entry.get('badge') or '' for entry in data.get('entries', [])]
            print(f"entries={','.join(e for e in entries if e)}")
            domains = [str(domain) for domain in data.get('domains', []) if domain]
            print(f"domains={','.join(domains)}")
          PY
          echo "result=$(cat $RESULT_FILE)" >> $GITHUB_OUTPUT

      - name: Recalculate level after award
        if: steps.award.outputs.awarded == 'true'
        run: |
          PR_USER="${{ steps.pr-info.outputs.user }}"
          python - <<'PY'
            import json, pathlib, yaml, os
            user = os.environ['PR_USER']
            path = pathlib.Path('metrics/users') / f"{user}.json"
            if not path.exists():
                raise SystemExit(f"Ledger missing for {user}")
            data = json.loads(path.read_text())
            rules = yaml.safe_load(pathlib.Path('metrics/xp-rules.yml').read_text()) or {}
            levels = rules.get('levels', {})
            xp = data.get('xp_total', 0)
            level = 'L0'
            for key, info in sorted(levels.items(), key=lambda item: float(item[1].get('min_xp', 0))):
                min_xp = float(info.get('min_xp', 0))
                if xp >= min_xp:
                    level = key
            path.write_text(json.dumps({**data, 'level': level}, indent=2, ensure_ascii=False))
          PY

      - name: Commit regulatory ledger changes
        if: steps.award.outputs.awarded == 'true'
        run: |
          git config user.name "atlantic-bot"
          git config user.email "bot@atlantic.ai"
          git add metrics/users/
          if git diff --cached --quiet; then
            echo "No ledger changes to commit."
          else
            git commit -m "xp: award regulatory XP"
            git push
          fi

      - name: Comment on PR about regulatory XP
        if: steps.award.outputs.awarded == 'true'
        uses: actions/github-script@v7
        env:
          PR_NUMBER: ${{ steps.pr-info.outputs.pr_number }}
          PR_USER: ${{ steps.pr-info.outputs.user }}
          XP_GRANTED: ${{ steps.award.outputs.xp_awarded }}
          ENTRY_TYPES: ${{ steps.award.outputs.entries }}
          DOMAINS: ${{ steps.award.outputs.domains }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = parseInt(process.env.PR_NUMBER || '0', 10);
            if (!prNumber) throw new Error('Missing PR number');
            const xp = Number(process.env.XP_GRANTED || '0');
            const entries = (process.env.ENTRY_TYPES || '').split(',').filter(Boolean);
            const domains = (process.env.DOMAINS || '').split(',').filter(Boolean);
            const entryList = entries.length
              ? entries.map((entry) => `‚Ä¢ ${entry}`).join('\n')
              : '‚Ä¢ regulatory contribution';
            const domainList = domains.length ? domains.join(', ') : 'regulatory';
            const body = [
              'üèõÔ∏è **XP regulatorio adjudicado**',
              `üéØ **+${xp} XP** (no decae)`,
              '',
              'üßæ Registro:',
              `- Dominios: ${domainList}`,
              `- Reglas: ${entryList}`,
              '',
              `Consulta el ledger en [metrics/users/${process.env.PR_USER}.json](https://github.com/${context.repo.owner}/${context.repo.repo}/blob/main/metrics/users/${process.env.PR_USER}.json).`,
              'Tambi√©n puedes ver las reglas declarativas en [docs/portal/metrics.md](https://github.com/${context.repo.owner}/${context.repo.repo}/docs/portal/metrics.md).',
              'Gracias por mantener la calidad y el cumplimiento.'
            ].join('\n');
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body,
            });
