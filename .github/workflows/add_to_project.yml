name: Gamification -> Add Issues/PRs to Project (v2)

on:
  issues:
    types: [opened, labeled, reopened]
  pull_request:
    types: [opened, labeled, reopened, ready_for_review]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  add-to-project:
    runs-on: ubuntu-latest
    steps:
      - name: Add to Project (requires secret PROJECT_TOKEN)
        uses: actions/add-to-project@v1.0.2
        with:
          project-url: ${{ secrets.PROJECT_URL }}
          github-token: ${{ secrets.PROJECT_TOKEN }}
          labeled: |
            good first issue
            learning-task
            ci-gitops
            automation
            ci-boott

      - name: Optional: set gamification fields (Level/XP) via GitHub Script
        if: ${{ secrets.PROJECT_TOKEN != '' }}
        uses: actions/github-script@v7
        env:
          PROJECT_TOKEN: ${{ secrets.PROJECT_TOKEN }}
          PROJECT_URL: ${{ secrets.PROJECT_URL }}
        with:
          github-token: ${{ secrets.PROJECT_TOKEN }}
          script: |
            /**
             * This step is OPTIONAL. It is intentionally conservative:
             * - It does NOT fail the workflow if it cannot update fields.
             * - It shows where to extend mapping logic.
             *
             * Setup instructions in .github/project_v2/README.md
             */
            const core = require('@actions/core');
            try {
              const payload = context.payload;
              const isIssue = !!payload.issue;
              const item = isIssue ? payload.issue : payload.pull_request;
              const labels = (item.labels || []).map(l => (typeof l === 'string' ? l : l.name)).filter(Boolean);

              // Simple mapping: Level by labels (extend as you wish)
              const level =
                labels.includes('good first issue') ? '1' :
                labels.includes('learning-task') ? '2' :
                labels.includes('ci-gitops') ? '3' :
                labels.includes('automation') ? '3' :
                labels.includes('ci-boott') ? '2' : '';

              // XP mapping (very simple baseline)
              const xp = level === '1' ? 10 : level === '2' ? 25 : level === '3' ? 50 : level === '4' ? 100 : 0;

              core.info(`Detected labels: ${labels.join(', ')}`);
              core.info(`Suggested Level=${level}, XP=${xp}`);

              // NOTE: Updating Project v2 fields requires:
              // - Knowing the Project ID
              // - Knowing the Item ID in the project
              // - Knowing Field IDs (Level, XP) and option IDs for Level
              //
              // We keep this as a safe placeholder to avoid breaking CI.
              // Use .github/project_v2/README.md to enable full sync with GraphQL.
            } catch (e) {
              core.warning(`Gamification field update skipped: ${e.message}`);
            }
