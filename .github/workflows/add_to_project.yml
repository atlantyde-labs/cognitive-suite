name: Gamification -> Add Issues/PRs to Org Project (v2)

on:
  issues:
    types: [opened, labeled, reopened]
  pull_request:
    types: [opened, labeled, reopened, ready_for_review]
  workflow_dispatch:

permissions:
  contents: read
  issues: write
  pull-requests: write
  repository-projects: write

jobs:
  add-to-project:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Add Issue/PR to Org Project (by labels)
        if: ${{ secrets.PROJECT_TOKEN != '' }}
        uses: actions/add-to-project@v1.0.2
        with:
          project-url: ${{ secrets.PROJECT_URL != '' && secrets.PROJECT_URL || 'https://github.com/orgs/atlantyde-labs/projects/2' }}
          github-token: ${{ secrets.PROJECT_TOKEN }}
          labeled: good-first-issue, learning-task, ci-gitops, automation, ci-boott
          label-operator: OR

      - name: Calculate Gamification Rewards
        id: gamification
        if: ${{ secrets.PROJECT_TOKEN != '' }}
        run: |
          # Get labels from payload
          LABELS=$(jq -r '.issue.labels[].name // .pull_request.labels[].name' $GITHUB_EVENT_PATH | tr '\n' ',' | sed 's/,$//')
          echo "Labels: $LABELS"

          # Determine level based on specific labels
          if echo "$LABELS" | grep -i -q "good first issue"; then LEVEL="level_1";
          elif echo "$LABELS" | grep -i -q "learning-task"; then LEVEL="level_2";
          elif echo "$LABELS" | grep -i -q "ci-gitops\|automation"; then LEVEL="level_3";
          elif echo "$LABELS" | grep -i -q "ci-boott"; then LEVEL="level_2";
          else LEVEL="none"; fi

          if [ "$LEVEL" != "none" ]; then
            REWARDS=$(python scripts/gamification_engine.py --level-info "$LEVEL" --json)
            # Standardize level name for single-select (e.g. "1")
            LEVEL_NUM=$(echo $REWARDS | jq -r .label | cut -d':' -f1 | sed 's/L//' | tr -d ' ')
            echo "level_num=$LEVEL_NUM" >> $GITHUB_OUTPUT
            echo "xp=$(echo $REWARDS | jq -r .xp)" >> $GITHUB_OUTPUT
            echo "mapped=true" >> $GITHUB_OUTPUT
          else
            echo "mapped=false" >> $GITHUB_OUTPUT
          fi

      - name: Set Project fields (Level/XP) in Org Project v2 (GraphQL)
        if: ${{ secrets.PROJECT_TOKEN != '' && steps.gamification.outputs.mapped == 'true' }}
        uses: actions/github-script@v7
        env:
          PROJECT_URL: ${{ secrets.PROJECT_URL != '' && secrets.PROJECT_URL || 'https://github.com/orgs/atlantyde-labs/projects/2' }}
          CALC_LEVEL: ${{ steps.gamification.outputs.level_num }}
          CALC_XP: ${{ steps.gamification.outputs.xp }}
        with:
          github-token: ${{ secrets.PROJECT_TOKEN }}
          script: |
            const { org, number } = (function(url) {
              const m = url.match(/github\.com\/orgs\/([^/]+)\/projects\/(\d+)/i);
              if (!m) throw new Error(`PROJECT_URL not recognized: ${url}`);
              return { org: m[1], number: parseInt(m[2], 10) };
            })(process.env.PROJECT_URL);

            async function gql(query, variables) { return await github.graphql(query, variables); }

            async function findProjectItemId(projectId, contentId) {
              let cursor = null;
              for (let i = 0; i < 20; i++) {
                const res = await gql(`
                  query($projectId: ID!, $cursor: String) {
                    node(id: $projectId) {
                      ... on ProjectV2 {
                        items(first: 100, after: $cursor) {
                          pageInfo { hasNextPage endCursor }
                          nodes {
                            id
                            content { ... on Issue { id } ... on PullRequest { id } }
                          }
                        }
                      }
                    }
                  }
                `, { projectId, cursor });
                const items = res.node.items.nodes || [];
                for (const it of items) { if (it.content?.id === contentId) return it.id; }
                const pi = res.node.items.pageInfo;
                if (!pi.hasNextPage) return null;
                cursor = pi.endCursor;
              }
              return null;
            }

            try {
              const payload = context.payload;
              const item = payload.issue || payload.pull_request;
              if (!item) return;

              const level = process.env.CALC_LEVEL;
              const xp = parseInt(process.env.CALC_XP, 10);
              const contentId = item.node_id;

              const projData = await gql(`
                query($org: String!, $number: Int!) {
                  organization(login: $org) {
                    projectV2(number: $number) {
                      id
                      fields(first: 50) {
                        nodes {
                          __typename
                          ... on ProjectV2Field { id name dataType }
                          ... on ProjectV2SingleSelectField { id name options { id name } }
                        }
                      }
                    }
                  }
                }
              `, { org, number });

              const project = projData.organization.projectV2;
              const projectId = project.id;
              const fields = project.fields.nodes;

              const levelField = fields.find(f => f.name === "Level");
              const xpField = fields.find(f => f.name === "XP");

              if (!levelField || !xpField) throw new Error("Missing Level or XP field in project");

              const levelOption = (levelField.options || []).find(o => o.name === level);
              if (!levelOption) throw new Error(`Option "${level}" not found in Level field`);

              let projectItemId = await findProjectItemId(projectId, contentId);
              if (!projectItemId) {
                const addRes = await gql(`
                  mutation($projectId: ID!, $contentId: ID!) {
                    addProjectV2ItemById(input: { projectId: $projectId, contentId: $contentId }) { item { id } }
                  }
                `, { projectId, contentId });
                projectItemId = addRes.addProjectV2ItemById.item.id;
              }

              // Update Level
              await gql(`
                mutation($projectId: ID!, $itemId: ID!, $fieldId: ID!, $optionId: String!) {
                  updateProjectV2ItemFieldValue(input: {
                    projectId: $projectId, itemId: $itemId, fieldId: $fieldId,
                    value: { singleSelectOptionId: $optionId }
                  }) { projectV2Item { id } }
                }
              `, { projectId, itemId: projectItemId, fieldId: levelField.id, optionId: levelOption.id });

              // Update XP
              await gql(`
                mutation($projectId: ID!, $itemId: ID!, $fieldId: ID!, $number: Float!) {
                  updateProjectV2ItemFieldValue(input: {
                    projectId: $projectId, itemId: $itemId, fieldId: $fieldId,
                    value: { number: $number }
                  }) { projectV2Item { id } }
                }
              `, { projectId, itemId: projectItemId, fieldId: xpField.id, number: xp });

              core.info(`âœ… Updated Project: Level=${level}, XP=${xp}`);
            } catch (e) {
              core.warning(`Update skipped: ${e.message}`);
            }
