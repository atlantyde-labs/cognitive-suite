name: Gamification -> Add Issues/PRs to Org Project (v2)

on:
  issues:
    types: [opened, labeled, reopened]
  pull_request:
    types: [opened, labeled, reopened, ready_for_review]
  workflow_dispatch:

# Even if you use a PAT (PROJECT_TOKEN), these permissions are safe and future-proof.
permissions:
  contents: read
  issues: write
  pull-requests: write
  repository-projects: write

jobs:
  add-to-project:
    runs-on: ubuntu-latest
    steps:
      - name: Determine PROJECT_URL (org project)
        id: determine_project_url
        run: |
          # Prefer secret, fallback to the known org project URL
          if [ -n "${{ secrets.PROJECT_URL }}" ]; then
            echo "project_url=${{ secrets.PROJECT_URL }}" >> $GITHUB_OUTPUT
          else
            echo "project_url=https://github.com/orgs/atlantyde-labs/projects/2" >> $GITHUB_OUTPUT
          fi

      - name: Check for PROJECT_TOKEN presence
        id: check_token
        run: |
          if [ -n "${{ secrets.PROJECT_TOKEN }}" ]; then
            echo "has_token=true" >> $GITHUB_OUTPUT
          else
            echo "has_token=false" >> $GITHUB_OUTPUT
          fi

      - name: Add Issue/PR to Org Project (by labels)
        if: ${{ steps.check_token.outputs.has_token == 'true' && steps.determine_project_url.outputs.project_url != '' }}
        uses: actions/add-to-project@v1.0.2
        with:
          project-url: ${{ steps.determine_project_url.outputs.project_url }}
          github-token: ${{ secrets.PROJECT_TOKEN }}
          labeled: |
            good first issue
            learning-task
            ci-gitops
            automation
            ci-boott

      - name: "Optional: compute gamification fields (Level/XP) (safe)"
        if: ${{ steps.check_token.outputs.has_token == 'true' && steps.determine_project_url.outputs.project_url != '' }}
        uses: actions/github-script@v7
        env:
          PROJECT_URL: ${{ steps.determine_project_url.outputs.project_url }}
        with:
          github-token: ${{ secrets.PROJECT_TOKEN }}
          script: |
            /**
             * OPTIONAL + SAFE:
             * - Does NOT fail workflow
             * - Computes Level/XP from labels
             * - Logs suggested values
             *
             * If you want to WRITE fields in the Org Project v2:
             * - Add GraphQL mutations updateProjectV2ItemFieldValue(...)
             * - Requires Project fields "Level" (single select) and "XP" (number)
             */
            try {
              const payload = context.payload;
              const isIssue = !!payload.issue;
              const item = isIssue ? payload.issue : payload.pull_request;

              if (!item) {
                core.info("No issue/pull_request in payload; skipping.");
                return;
              }

              const labels = (item.labels || [])
                .map(l => (typeof l === 'string' ? l : l.name))
                .filter(Boolean);

              const level =
                labels.includes('good first issue') ? '1' :
                labels.includes('learning-task') ? '2' :
                labels.includes('ci-gitops') ? '3' :
                labels.includes('automation') ? '3' :
                labels.includes('ci-boott') ? '2' : '';

              const xp = level === '1' ? 10 : level === '2' ? 25 : level === '3' ? 50 : level === '4' ? 100 : 0;

              core.info(`Project URL: ${process.env.PROJECT_URL}`);
              core.info(`Detected labels: ${labels.join(', ')}`);
              core.info(`Suggested Level=${level || '(none)'}, XP=${xp}`);
            } catch (e) {
              core.warning(`Gamification field compute skipped: ${e.message}`);
            }
