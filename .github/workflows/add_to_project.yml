name: Gamification -> Add Issues/PRs to Project (v2)

on:
  issues:
    types: [opened, labeled, reopened]
  pull_request:
    types: [opened, labeled, reopened, ready_for_review]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  add-to-project:
    runs-on: ubuntu-latest
    steps:
      - name: Create Project v2 if PROJECT_URL not set (requires PROJECT_TOKEN)
        id: create_project
        if: ${{ secrets.PROJECT_TOKEN != '' && secrets.PROJECT_URL == '' }}
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PROJECT_TOKEN }}
          script: |
            const core = require('@actions/core');
            try {
              if (!process.env.PROJECT_TOKEN) {
                core.info('PROJECT_TOKEN not set; skipping project creation.');
                return;
              }
              if (process.env.PROJECT_URL) {
                core.info('PROJECT_URL already set; skipping project creation.');
                return;
              }

              const { owner, repo } = context.repo;
              core.info(`Repo: ${owner}/${repo} â€” fetching repository GraphQL id...`);

              // Get repository GraphQL id
              const repoQuery = `query($owner:String!, $repo:String!){
                repository(owner:$owner, name:$repo){ id }
              }`;
              const repoRes = await github.graphql(repoQuery, { owner, repo });
              const ownerId = repoRes.repository.id;
              core.info(`Repository id: ${ownerId}`);

              // Create Project v2
              const input = {
                ownerId,
                title: "Cognitive Suite Project",
                shortDescription: "Auto-created project by workflow"
              };
              const mutation = `mutation($input: CreateProjectV2Input!) {
                createProjectV2(input: $input) {
                  projectV2 { id number }
                }
              }`;
              const createRes = await github.graphql(mutation, { input });
              const number = createRes.createProjectV2.projectV2.number;
              const projectUrl = `https://github.com/${owner}/${repo}/projects/${number}`;

              core.info(`Created Project v2 number=${number}`);
              core.info(`Suggested PROJECT_URL: ${projectUrl}`);

              // Expose as step output so subsequent steps can use it
              core.setOutput('project_number', number);
              core.setOutput('project_url', projectUrl);
            } catch (e) {
              core.warning(`Project creation skipped: ${e.message}`);
            }

      - name: Add to Project (requires secret PROJECT_TOKEN)
        uses: actions/add-to-project@v1.0.2
        with:
          # Prefer the explicitly-provided secret PROJECT_URL, otherwise use the project_url output from the create_project step
          project-url: ${{ secrets.PROJECT_URL != '' && secrets.PROJECT_URL || steps.create_project.outputs.project_url }}
          github-token: ${{ secrets.PROJECT_TOKEN }}
          labeled: |
            good first issue
            learning-task
            ci-gitops
            automation
            ci-boott

      - name: Optional: set gamification fields (Level/XP) via GitHub Script
        if: ${{ secrets.PROJECT_TOKEN != '' }}
        uses: actions/github-script@v7
        env:
          PROJECT_TOKEN: ${{ secrets.PROJECT_TOKEN }}
          PROJECT_URL: ${{ secrets.PROJECT_URL }}
        with:
          github-token: ${{ secrets.PROJECT_TOKEN }}
          script: |
            /**
             * This step is OPTIONAL. It is intentionally conservative:
             * - It does NOT fail the workflow if it cannot update fields.
             * - It shows where to extend mapping logic.
             *
             * Setup instructions in .github/project_v2/README.md
             */
            const core = require('@actions/core');
            try {
              const payload = context.payload;
              const isIssue = !!payload.issue;
              const item = isIssue ? payload.issue : payload.pull_request;
              const labels = (item.labels || []).map(l => (typeof l === 'string' ? l : l.name)).filter(Boolean);

              // Simple mapping: Level by labels (extend as you wish)
              const level =
                labels.includes('good first issue') ? '1' :
                labels.includes('learning-task') ? '2' :
                labels.includes('ci-gitops') ? '3' :
                labels.includes('automation') ? '3' :
                labels.includes('ci-boott') ? '2' : '';

              // XP mapping (very simple baseline)
              const xp = level === '1' ? 10 : level === '2' ? 25 : level === '3' ? 50 : level === '4' ? 100 : 0;

              core.info(`Detected labels: ${labels.join(', ')}`);
              core.info(`Suggested Level=${level}, XP=${xp}`);

              // NOTE: Updating Project v2 fields requires:
              // - Knowing the Project ID
              // - Knowing the Item ID in the project
              // - Knowing Field IDs (Level, XP) and option IDs for Level
              //
              // We keep this as a safe placeholder to avoid breaking CI.
              // Use .github/project_v2/README.md to enable full sync with GraphQL.
            } catch (e) {
              core.warning(`Gamification field update skipped: ${e.message}`);
            }
