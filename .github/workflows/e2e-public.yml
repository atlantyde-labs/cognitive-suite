name: E2E Public Runner Validation

on:
  push:
    branches: [ chore/scripts-testing, E2E ]
  pull_request:
    branches: [ chore/scripts-testing, E2E ]
  workflow_dispatch:

permissions:
  contents: read
  security-events: write

jobs:
  security:
    uses: ./.github/workflows/ci-security.yml
    permissions:
      contents: read
      security-events: write

  e2e:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install tooling
        run: |
          sudo apt-get update
          sudo apt-get install -y shellcheck ripgrep

      - name: Shellcheck scripts
        run: |
          set -euo pipefail
          mkdir -p outputs/ci-evidence
          scripts=$(rg --files -g "*.sh" bash/GitDevSecDataAIOps scripts)
          if [[ -n "${scripts}" ]]; then
            printf '%s\n' ${scripts} > outputs/ci-evidence/shellcheck-files.txt
            bash -n ${scripts} 2> outputs/ci-evidence/bash-n.txt
            shellcheck ${scripts} | tee outputs/ci-evidence/shellcheck.txt
          fi

      - name: Python syntax check
        run: |
          set -euo pipefail
          mkdir -p outputs/ci-evidence
          pyfiles=$(rg --files -g "*.py" bash/GitDevSecDataAIOps)
          if [[ -n "${pyfiles}" ]]; then
            printf '%s\n' ${pyfiles} > outputs/ci-evidence/python-files.txt
            python3 -m py_compile ${pyfiles}
          fi

      - name: Validate fine-tune dataset
        run: |
          set -euo pipefail
          mkdir -p outputs/ci-evidence/ft_outputs
          python3 bash/GitDevSecDataAIOps/tooling/fine-tune/ft_prepare.py \
            datasets/atlantityqa_cognitive_suite_ft_v2.jsonl --validate-only | tee outputs/ci-evidence/ft-validate.log
          python3 bash/GitDevSecDataAIOps/tooling/fine-tune/ft_prepare.py \
            datasets/atlantityqa_cognitive_suite_ft_v2.jsonl --split-by-sensitivity --out-dir outputs/ci-evidence/ft_outputs

      - name: Model inventory (dry-run)
        run: |
          set -euo pipefail
          python3 bash/GitDevSecDataAIOps/tooling/models/model_inventory.py \
            --roots datasets \
            --output outputs/ci-evidence/model-inventory.json \
            --whitelist-output outputs/ci-evidence/model-whitelist.json \
            --alerts-output outputs/ci-evidence/model-alerts.json \
            --hash none \
            --default-sensitivity INTERNAL \
            --dry-run

      - name: Mocked ops simulation (air-gap + Proxmox)
        run: |
          set -euo pipefail
          mkdir -p outputs/ci-evidence
          EVIDENCE_DIR=outputs/ci-evidence \
            bash bash/GitDevSecDataAIOps/tooling/tests/mock-e2e.sh | tee outputs/ci-evidence/mock-e2e.log

      - name: Write evidence summary
        run: |
          set -euo pipefail
          mkdir -p outputs/ci-evidence
          python3 - <<'PY' > outputs/ci-evidence/summary.json
          import json
          import os
          import subprocess
          from datetime import datetime, timezone

          def get(cmd):
            return subprocess.check_output(cmd, text=True).strip()

          summary = {
            "timestamp": datetime.now(timezone.utc).isoformat(),
            "commit": get(["git", "rev-parse", "HEAD"]),
            "ref": os.environ.get("GITHUB_REF", ""),
            "ref_name": os.environ.get("GITHUB_REF_NAME", ""),
            "run_id": os.environ.get("GITHUB_RUN_ID", ""),
            "run_number": os.environ.get("GITHUB_RUN_NUMBER", ""),
            "workflow": os.environ.get("GITHUB_WORKFLOW", ""),
          }
          print(json.dumps(summary, ensure_ascii=True, indent=2))
          PY

      - name: Upload E2E evidence
        uses: actions/upload-artifact@v4
        with:
          name: e2e-evidence
          path: outputs/ci-evidence

  gates:
    runs-on: ubuntu-latest
    needs: [security, e2e]
    steps:
      - name: Write gate summary
        run: |
          set -euo pipefail
          cat <<'JSON' > gate-summary.json
          {
            "security": "${{ needs.security.result }}",
            "e2e": "${{ needs.e2e.result }}"
          }
          JSON

      - name: Upload gate summary
        uses: actions/upload-artifact@v4
        with:
          name: ci-gates
          path: gate-summary.json
